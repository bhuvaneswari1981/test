compute_envs_stack:
  stack_name: "project-ped-{{ app_env }}-computeenvs-stack"
  vpc_id: "{{ account_vpc_id }}"
  xray_daemon: true
  compute_envs:
    # General Purpose Compute Environment - Multiple instance types for flexibility
    - name: "{{ app_env | title }}CompEnv_GeneralPurpose"
      role_arn: "{{ iam_arn }}:role/project/{{ project_ped_batch_service_role }}"
      instance_role_arn: "{{ iam_arn }}:role/project/{{ ec2all_iam_role }}"
      instance_types: ["m6i.large", "m6i.xlarge", "m5.large", "m5.xlarge"]  # Multiple types for fallback
      instance_ami: "vaec-al-2-x86_64-ecs-2023-01-27"
      minv_cpus: 0
      maxv_cpus: 256
      security_groups: ["{{ compute_security_group_id }}"]
      job_queues:
        - name: "{{ app_env }}JobQueue_GeneralPurpose"
          priority: 10
          description: "General purpose workloads with multiple instance type fallback"

    # CPU-Intensive Compute Environment - Optimized for compute-heavy tasks
    - name: "{{ app_env | title }}CompEnv_CPUIntensive"
      role_arn: "{{ iam_arn }}:role/project/{{ project_ped_batch_service_role }}"
      instance_role_arn: "{{ iam_arn }}:role/project/{{ ec2all_iam_role }}"
      instance_types: ["c6i.large", "c6i.xlarge", "c5.large", "c5.xlarge"]  # CPU-optimized with fallback
      instance_ami: "vaec-al-2-x86_64-ecs-2023-01-27"
      minv_cpus: 0
      maxv_cpus: 512  # Higher capacity for CPU-intensive workloads
      security_groups: ["{{ compute_security_group_id }}"]
      use_spot_instances: true  # Cost optimization for batch processing
      job_queues:
        - name: "{{ app_env }}JobQueue_CPUIntensive"
          priority: 20
          description: "CPU-intensive workloads like data processing and analysis"

    # Memory-Intensive Compute Environment - Optimized for memory-heavy tasks
    - name: "{{ app_env | title }}CompEnv_MemoryIntensive"
      role_arn: "{{ iam_arn }}:role/project/{{ project_ped_batch_service_role }}"
      instance_role_arn: "{{ iam_arn }}:role/project/{{ ec2all_iam_role }}"
      instance_types: ["r6i.large", "r6i.xlarge", "r5.large", "r5.xlarge"]  # Memory-optimized with fallback
      instance_ami: "vaec-al-2-x86_64-ecs-2023-01-27"
      minv_cpus: 0
      maxv_cpus: 256
      security_groups: ["{{ compute_security_group_id }}"]
      job_queues:
        - name: "{{ app_env }}JobQueue_MemoryIntensive"
          priority: 15
          description: "Memory-intensive workloads like large dataset processing"

    # Fargate Environment - Serverless option for lighter workloads
    - name: "{{ app_env | title }}CompEnv_Fargate"
      role_arn: "{{ iam_arn }}:role/project/{{ project_ped_batch_service_role }}"
      instance_role_arn: "{{ iam_arn }}:instance-profile/project/{{ ec2all_iam_profile }}"
      security_groups: ["{{ compute_security_group_id }}"]
      fargate: true
      job_queues:
        - name: "{{ app_env }}JobQueue_Fargate"
          priority: 5
          description: "Serverless workloads with quick startup and no instance management"

