- name: promoteBuildArtifact | Ensure sparse checkout is fully disabled
  ansible.builtin.shell: |
    git config core.sparseCheckout false
    rm -f .git/info/sparse-checkout || true
    git read-tree -mu HEAD
  args:
    chdir: "{{ destination_directory }}/{{ github_repo_name }}"
  tags: skip_ansible_lint

- name: promoteBuildArtifact | Confirm artifact file exists locally
  ansible.builtin.stat:
    path: "{{ destination_directory }}/{{ github_repo_name }}/{{ item.artifact_folder }}/{{ item.filename }}"
  register: artifact_stat
  loop: "{{ files_to_release }}"
  loop_control:
    loop_var: item

- name: promoteBuildArtifact | Add and commit artifact if it exists and has changes
  ansible.builtin.shell: |
    git add --force {{ item.artifact_folder }}/{{ item.filename }}
    if [ -n "$(git status --porcelain {{ item.artifact_folder }}/{{ item.filename }})" ]; then
      git commit -m "{{ commit_message }}"
    fi
  args:
    chdir: "{{ destination_directory }}/{{ github_repo_name }}"
  loop: "{{ files_to_release }}"
  loop_control:
    loop_var: item
  when: item_stat.stat.exists
  vars:
    item_stat: "{{ artifact_stat.results[loop.index0] }}"
  tags: skip_ansible_lint

- name: promoteBuildArtifact | Pull latest to avoid push rejection
  ansible.builtin.shell: git pull origin {{ target_branch }} --rebase
  args:
    chdir: "{{ destination_directory }}/{{ github_repo_name }}"
  tags: skip_ansible_lint

- name: promoteBuildArtifact | Push changes to target branch
  ansible.builtin.shell: git push origin {{ target_branch }}
  args:
    chdir: "{{ destination_directory }}/{{ github_repo_name }}"
  tags: skip_ansible_lint

- name: promoteBuildArtifact | Verify pushed artifact is in remote
  ansible.builtin.shell: |
    git fetch origin {{ target_branch }}
    git ls-tree -r origin/{{ target_branch }} --name-only
  args:
    chdir: "{{ destination_directory }}/{{ github_repo_name }}"
  register: remote_listing
  tags: skip_ansible_lint

- name: promoteBuildArtifact | Show remote contents after push
  debug:
    msg: "{{ remote_listing.stdout_lines }}"
  tags: always

