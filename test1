- name: promoteBuildArtifact | Promote each artifact from develop to {{ target_branch }}
  block:
    - name: Disable sparse checkout and configure Git
      ansible.builtin.shell: |
        git config core.sparseCheckout false
        git config advice.detachedHead false
        git config advice.updateSparsePath false
      args:
        chdir: "{{ destination_directory }}/{{ github_repo_name }}"

    - name: Fetch latest from remote
      ansible.builtin.shell: |
        git fetch origin
        git checkout {{ target_branch }}
        git pull origin {{ target_branch }}
      args:
        chdir: "{{ destination_directory }}/{{ github_repo_name }}"

    - name: Checkout artifact from develop
      ansible.builtin.shell: |
        git checkout origin/develop -- {{ item.artifact_folder }}/{{ item.filename }}
      args:
        chdir: "{{ destination_directory }}/{{ github_repo_name }}"
      loop: "{{ files_to_release }}"
      loop_control:
        label: "{{ item.filename }}"

    - name: Commit artifact if changed
      ansible.builtin.shell: |
        if [ -n "$(git status --porcelain {{ item.artifact_folder }}/{{ item.filename }})" ]; then
          git add {{ item.artifact_folder }}/{{ item.filename }}
          git commit -m "Promoting artifact {{ item.filename }} for {{ tag_name }} at $(date -u +%Y-%m-%d)"
        fi
      args:
        chdir: "{{ destination_directory }}/{{ github_repo_name }}"
      loop: "{{ files_to_release }}"
      loop_control:
        label: "{{ item.filename }}"

    - name: Push committed artifacts to target branch
      ansible.builtin.shell: |
        git push origin {{ target_branch }}
      args:
        chdir: "{{ destination_directory }}/{{ github_repo_name }}"

    - name: Verify promoted artifacts are in remote
      ansible.builtin.shell: |
        git fetch origin {{ target_branch }}
        git ls-tree -r origin/{{ target_branch }} --name-only
      args:
        chdir: "{{ destination_directory }}/{{ github_repo_name }}"
      register: pushed_files

    - name: Debug list of pushed artifacts
      debug:
        var: pushed_files.stdout_lines

  rescue:
    - name: Debug failure info
      debug:
        msg: "Artifact promotion failed at one of the steps."


