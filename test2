- name: promoteBuildArtifact | Commit artifacts
  ansible.builtin.shell: |
    cd "{{ destination_directory }}/{{ github_repo_name }}"
    git add .
    git_status=$(git status --porcelain)
    if [ -n "$git_status" ]; then
      git commit -m "fpps_promoteBuildArtifacts_{{ release_tag }}_{{ lookup('pipe', 'date +%Y%m%d') }}"
    fi
  args:
    chdir: "{{ destination_directory }}/{{ github_repo_name }}"
  register: git_commit
  changed_when: "'nothing to commit' not in git_commit.stdout"
  tags: skip_ansible_lint

- name: promoteBuildArtifact | Create and push tag (only if not exists)
  ansible.builtin.shell: |
    cd "{{ destination_directory }}/{{ github_repo_name }}"
    if [ -z "$(git tag -l {{ release_tag }})" ]; then
      git tag -a {{ release_tag }} -m "Tagging artifacts with version {{ release_tag }}"
    fi
    git push origin {{ target_branch }} --tags || (git fetch origin && git push origin {{ target_branch }} --tags --force)
  args:
    chdir: "{{ destination_directory }}/{{ github_repo_name }}"
  register: git_push
  failed_when: git_push.rc != 0 and 'tag already exists' not in git_push.stderr
  tags: skip_ansible_lint
